@model IEnumerable<Projeto22025.Models.Relatorio>

@{
    ViewData["Title"] = "Média de Saída por Produto";
}

<h2>@ViewData["Title"]</h2>
<p>Calcula a média de itens por saída (requisição).</p>
<hr />

<div class="mb-3">
    <button id="btnGerarPdf" class="btn btn-danger">
        Gerar PDF</button>
        <a asp-action="ExportarMediaSaidaExcel" class="btn btn-success">Gerar Excel</a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <table class="table table-striped table-hover" id="tabelaRelatorio">
            <thead class="table-dark">
                <tr>
                    <th>Produto (Grupo)</th>
                    <th>Média de Itens por Saída</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Grupo</td>
                        <!-- Formata a média (double) para 2 casas decimais -->
                        <td>@item.Total.ToString("F2")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <!-- Script do PDF (Versão Corrigida) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const { jsPDF } = window.jspdf;
            document.getElementById('btnGerarPdf').addEventListener('click', function () {
                const elemento = document.getElementById('tabelaRelatorio');
                const cabecalho = elemento.querySelector('thead');

                // 1. Remove as classes que estragam o PDF
                cabecalho.classList.remove('table-dark');
                elemento.classList.remove('table-striped', 'table-hover');
                elemento.classList.add('table-pdf-format'); // Adiciona estilo "limpo"

                html2canvas(elemento).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const margemX = 10;
                    const larguraUtil = pdfWidth - (margemX * 2);
                    const alturaUtil = (imgProps.height * larguraUtil) / imgProps.width;

                    doc.addImage(imgData, 'PNG', margemX, 10, larguraUtil, alturaUtil);
                    doc.save('Relatorio_MediaSaida.pdf');

                    // 2. Devolve as classes originais para a página
                    cabecalho.classList.add('table-dark');
                    elemento.classList.add('table-striped', 'table-hover');
                    elemento.classList.remove('table-pdf-format');
                });
            });
        });
    </script>
}