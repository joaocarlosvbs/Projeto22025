@model IEnumerable<Projeto22025.Models.Relatorio>

@{
    ViewData["Title"] = "Relatório de Estoque Valorado";
}

<!-- O seu título "Relatório de Valores" estava aqui -->
<h2>@ViewData["Title"]</h2>
<p>Calcula o valor total (R$) do estoque atual, agrupado por categoria.</p>
<hr />

<div class="mb-3">
    <button id="btnGerarPdf" class="btn btn-danger">
        Gerar PDF
    </button>
        <a asp-action="ExportarEstoqueValoradoExcel" class="btn btn-success">Gerar Excel</a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <table class="table table-striped table-hover" id="tabelaRelatorio">
            <thead class="table-dark">
                <tr>
                    <th>Categoria (Grupo)</th>
                    <th>Valor Total em Estoque (R$)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Grupo</td>
                        <!-- Formata o 'double' (Total) como Moeda (R$) -->
                        <td>@item.Total.ToString("C", new System.Globalization.CultureInfo("pt-BR"))</td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-group-divider">
                <tr style="font-weight: bold; font-size: 1.1rem;">
                    <td>Total Geral do Estoque</td>
                    <!-- O ViewBag.TotalGeral (double) também é formatado como Moeda -->
                    <td>@ViewBag.TotalGeral.ToString("C", new System.Globalization.CultureInfo("pt-BR"))</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

@section Scripts {
    <!-- Script do PDF (Versão Corrigida) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const { jsPDF } = window.jspdf;
            document.getElementById('btnGerarPdf').addEventListener('click', function () {
                const elemento = document.getElementById('tabelaRelatorio');
                const cabecalho = elemento.querySelector('thead');

                cabecalho.classList.remove('table-dark');
                elemento.classList.remove('table-striped', 'table-hover');
                elemento.classList.add('table-pdf-format');

                html2canvas(elemento).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const margemX = 10;
                    const larguraUtil = pdfWidth - (margemX * 2);
                    const alturaUtil = (imgProps.height * larguraUtil) / imgProps.width;

                    doc.addImage(imgData, 'PNG', margemX, 10, larguraUtil, alturaUtil);
                    doc.save('Relatorio_EstoqueValorado.pdf');

                    cabecalho.classList.add('table-dark');
                    elemento.classList.add('table-striped', 'table-hover');
                    elemento.classList.remove('table-pdf-format');
                });
            });
        });
    </script>
}